
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<title>Ring Clock</title>
<style>
:root{--bg:#111; --track:#333; --outer:#6CE0FF; --txt:#eee; --accent:#6CE0FF;
      --safe-top:env(safe-area-inset-top,0); --safe-bottom:env(safe-area-inset-bottom,0);}
*,*::before,*::after{box-sizing:border-box}
html,body{margin:0;height:100%;touch-action:manipulation;-webkit-user-select:none;user-select:none}
body{display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);color:var(--txt);font-family:system-ui,Arial;padding:var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left)}
#clockWrap{width:min(85vw,85vh);aspect-ratio:1/1;position:relative}
svg{width:100%;height:100%;transform:rotate(-90deg)}
circle{fill:none;stroke-linecap:round}
.track{stroke:var(--track)}
#outer{stroke:var(--outer);transition:stroke-dashoffset .3s ease}
#inner{stroke:var(--accent);transition:stroke-dashoffset .3s ease,stroke .3s ease}
#seconds{stroke:#FF47A3;transition:stroke-dashoffset .3s ease,stroke .2s ease}
#digital{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none}
#time{font-size:clamp(2.2rem,10vw,4rem);font-weight:600}
#sub{font-size:clamp(.9rem,4vw,1.2rem);margin-top:.3rem;opacity:.8}
#toggleSettings{position:fixed;bottom:calc(12px + var(--safe-bottom));right:12px;width:56px;height:56px;border-radius:50%;background:#222;color:var(--txt);border:none;font-size:1.7rem;display:grid;place-items:center;box-shadow:0 2px 8px #0006;z-index:10}
#settings{position:fixed;bottom:calc(76px + var(--safe-bottom));right:12px;width:min(280px,90vw);max-height:65vh;overflow-y:auto;background:#222;border-radius:12px;padding:.8rem 1rem;display:none;flex-direction:column;gap:.6rem;box-shadow:0 4px 20px #0009}
#settings.show{display:flex}
label{display:flex;justify-content:space-between;align-items:center;font-size:.95rem}
input[type=range]{width:100px}
input[type=color]{width:32px;height:32px;border:none;background:none}
button{padding:.45rem .7rem;font-size:.95rem}
small{color:#aaa;font-size:.8rem}
</style>
</head>
<body>

<div id="clockWrap">
  <svg viewBox="0 0 100 100" aria-label="Radial progress clock">
    <!-- tracks -->
    <circle class="track" cx="50" cy="50" r="45" stroke-width="8"/>
    <circle class="track" cx="50" cy="50" r="32" stroke-width="6"/>
    <circle class="track" cx="50" cy="50" r="22" stroke-width="2"/>
    <!-- arcs -->
    <circle id="outer" cx="50" cy="50" r="45" stroke-width="8"/>
    <circle id="inner" cx="50" cy="50" r="32" stroke-width="6"/>
    <circle id="seconds" cx="50" cy="50" r="22" stroke-width="2"/>
  </svg>
  <div id="digital">
    <span id="time">--:--</span>
    <small id="sub">--</small>
  </div>
</div>

<button id="toggleSettings" aria-label="Settings">⚙️</button>

<section id="settings">
  <h3 style="margin:0 0 .4rem">Settings</h3>

  <label>Outer Ø <span id="vOuter">100</span> mm
    <input type="range" id="dOuter" min="30" max="1000" value="750">
  </label>
  <label>Hour Ø <span id="vHour">74</span> mm
    <input type="range" id="dHour"  min="30" max="1000" value="520">
  </label>
  <label>Seconds Ø <span id="vSec">54</span> mm
    <input type="range" id="dSec"   min="30" max="1000" value="440">
  </label>

  <label>Outer colour
    <input type="color" id="cOuter" value="#6CE0FF">
  </label>
  <label>Track colour
    <input type="color" id="cTrack" value="#333333">
  </label>
  <label>Smooth anim
    <input type="checkbox" id="smooth" checked>
  </label>
  <label>Chime every
    <input type="number" id="chimeInt" min="1" max="120" value="60"> min
  </label>

  <div style="display:flex;gap:.5rem">
    <button id="sub10">-10 min</button>
    <button id="add10">+10 min</button>
    <button id="resetOff">Reset</button>
  </div>
  <small>Debug: shift local time</small>
</section>

<script>
/* ---------- CONFIG ---------- */
const STORE = key => `ringclk_${key}`;
let offsetMinutes = +(localStorage.getItem(STORE('offset'))||0);
let chimeEvery    = +(localStorage.getItem(STORE('chime'))||60);
let lastChimeMinute=-1, lastMinute=-1;

/* ---------- DOM ---------- */
const outer = document.getElementById('outer');
const inner = document.getElementById('inner');
const secEl = document.getElementById('seconds');
const trackO= document.querySelector('.track:nth-of-type(1)');
const trackI= document.querySelector('.track:nth-of-type(2)');
const trackS= document.querySelector('.track:nth-of-type(3)');
const timeTxt=document.getElementById('time');
const subTxt =document.getElementById('sub');
const smoothCk=document.getElementById('smooth');
const cOuter=document.getElementById('cOuter');
const cTrack=document.getElementById('cTrack');
const chimeInp=document.getElementById('chimeInt');
const settings=document.getElementById('settings');
const toggleBtn=document.getElementById('toggleSettings');
/* sliders */
const dOuter=document.getElementById('dOuter');
const dHour =document.getElementById('dHour');
const dSec  =document.getElementById('dSec');
const vOuter=document.getElementById('vOuter');
const vHour =document.getElementById('vHour');
const vSec  =document.getElementById('vSec');

/* ---------- RING SIZE HANDLER ---------- */
function mmToViewBox(mm){ return mm*0.1; }
function applyRingSizes(){
  const rO=mmToViewBox(dOuter.value)/2;
  const rI=mmToViewBox(dHour.value)/2;
  const rS=mmToViewBox(dSec.value)/2;
  /* move BOTH track and coloured ring */
  [outer,trackO].forEach(el=>el.setAttribute('r',rO));
  [inner,trackI].forEach(el=>el.setAttribute('r',rI));
  [secEl,trackS].forEach(el=>el.setAttribute('r',rS));
  /* update circumferences */
  const cO=2*Math.PI*rO, cI=2*Math.PI*rI, cS=2*Math.PI*rS;
  outer.style.strokeDasharray=cO;
  inner.style.strokeDasharray=cI;
  secEl.style.strokeDasharray=cS;
  /* save */
  localStorage.setItem(STORE('dOuter'),dOuter.value);
  localStorage.setItem(STORE('dHour'),dHour.value);
  localStorage.setItem(STORE('dSec'),dSec.value);
  draw(); /* force redraw */
}
[dOuter,dHour,dSec].forEach(el=>{
  el.oninput=()=>{
    applyRingSizes();
    vOuter.textContent=dOuter.value;
    vHour.textContent=dHour.value;
    vSec.textContent=dSec.value;
  };
});
/* load saved diameters & labels */
['dOuter','dHour','dSec'].forEach(id=>{
  if(localStorage.getItem(STORE(id))){
    document.getElementById(id).value=localStorage.getItem(STORE(id));
    document.getElementById(id.replace('d','v')).textContent=localStorage.getItem(STORE(id));
  }
});
applyRingSizes(); /* initial draw with saved sizes */

/* ---------- COLOUR UTILS ---------- */
function hourPercent(min,sec){ return (min*60+sec)/3600; }
function interpolateColor(p){
  const stops=[
    {pos:0,   rgb:[135,206,250]},  // light-blue
    {pos:.35, rgb:[0,200,100]},    // green
    {pos:.6,  rgb:[255,255,0]},    // yellow
    {pos:.8,  rgb:[255,140,0]},    // orange
    {pos:1,   rgb:[255,50,50]}     // red
  ];
  let i=stops.findIndex(s=>s.pos>=p);
  if(i===-1)i=stops.length-1; if(i===0)i=1;
  const s0=stops[i-1], s1=stops[i];
  const t=(p-s0.pos)/(s1.pos-s0.pos);
  const r=Math.round(s0.rgb[0]+(s1.rgb[0]-s0.rgb[0])*t);
  const g=Math.round(s0.rgb[1]+(s1.rgb[1]-s0.rgb[1])*t);
  const b=Math.round(s0.rgb[2]+(s1.rgb[2]-s0.rgb[2])*t);
  return `rgb(${r},${g},${b})`;
}
function randomVivid(){
  const hue=Math.floor(Math.random()*360);
  return `hsl(${hue},90%,60%)`;
}

/* ---------- SKY-COLOUR HELPERS ---------- */
// function skyColour(h){            // h = hour 0-24
//   const deep = { r: 11,  g: 26,  b: 58  };   // #0b1a3a
//   const rise = { r: 255, g: 94,  b: 77  };   // sunrise/sunset orange
//   const day  = { r: 135, g: 206, b: 250 };   // light blue

//   let mix;
//   if (h <= 5) {                       // 00→05  deep night
//     mix = 0;
//   } else if (h <= 6) {                // 05→06  sunrise
//     mix = (h - 5);
//   } else if (h <= 18) {               // 06→18  day
//     mix = 1;
//   } else if (h <= 19) {               // 18→19  sunset
//     mix = 1 - (h - 18);
//   } else {                            // 19→24  deep night
//     mix = 0;
//   }

//   function lerp(a,b,t){               // linear interpolate
//     return {
//       r: Math.round(a.r + (b.r - a.r) * t),
//       g: Math.round(a.g + (b.g - a.g) * t),
//       b: Math.round(a.b + (b.b - a.b) * t)
//     };
//   }

//   const colour = mix === 1 ? day :           // full day
//                  mix === 0 ? deep :          // full night
//                  lerp(deep, rise, mix);       // sunrise / sunset fade

//   return `rgb(${colour.r},${colour.g},${colour.b})`;
// }

/* ---------- SKY-COLOUR FROM API ---------- */
const LAT  = 37.943391;
const LNG  = -121.800546;
let sunTimes = null;   // {sunrise, sunset} in UTC minutes-of-day

/* fetch today’s sun times once, then every midnight */
async function loadSun(){
  const date  = new Date().toISOString().split('T')[0];  // YYYY-MM-DD
  const url   = `https://api.sunrise-sunset.org/json?lat=${LAT}&lng=${LNG}&date=${date}&formatted=0`;
  const res   = await fetch(url);
  const data  = await res.json();
  if(data.status !== 'OK') return;
  const r = new Date(data.results.civil_twilight_begin),
        s = new Date(data.results.civil_twilight_end);
  sunTimes = { sunrise : r.getUTCHours()*60 + r.getUTCMinutes(),
               sunset  : s.getUTCHours()*60 + s.getUTCMinutes() };
}
/* first call */
loadSun();
/* refresh at midnight local time */
setInterval(() => {
  const now = new Date();
  if (now.getHours() === 0 && now.getMinutes() === 0) loadSun();
}, 60_000);

/* ---------- DRAW ---------- */
function draw(){
  const now=new Date();
  now.setMinutes(now.getMinutes()+offsetMinutes);
  const h=now.getHours(), m=now.getMinutes(), s=now.getSeconds();

  
  /* outer ring = live sky colour */
  if (!sunTimes) {  // fallback until first fetch finishes
    outer.style.stroke = '#6CE0FF';
  } else {
    const nowMin = h*60 + m;
    const dayLen = sunTimes.sunset - sunTimes.sunrise;
    let sky = '#0b1a3a';                 // default night
    if (nowMin >= sunTimes.sunrise && nowMin <= sunTimes.sunset) {
      const p = (nowMin - sunTimes.sunrise) / dayLen;  // 0 → 1 → 0
      const mid = 1 - Math.abs(p - 0.5) * 2;           // 0 at noon, 1 at edges
      const r = Math.round(135 - mid * 120);
      const g = Math.round(206 - mid * 90);
      const b = Math.round(250 - mid * 40);
      sky = `rgb(${r},${g},${b})`;
    }
    outer.style.stroke = sky;
  }
  outer.style.strokeDashoffset = outer.style.strokeDasharray * (1 - dayP);

  /* inner 60min */
  const hourP=hourPercent(m,s);
  inner.style.strokeDashoffset=inner.style.strokeDasharray*(1-hourP);
  inner.style.stroke=interpolateColor(hourP);

  /* seconds */
  if(m!==lastMinute){ lastMinute=m; secEl.style.stroke=randomVivid(); }
  const secP=s/60;
  secEl.style.strokeDashoffset=secEl.style.strokeDasharray*(1-secP);

  /* digital */
  timeTxt.textContent=now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  subTxt.textContent=`${60-m-1} m ${60-s} s left`;

  /* chime */
  if(chimeEvery>0){
    const totalMin=h*60+m;
    if(totalMin%chimeEvery===0&&lastChimeMinute!==totalMin){
      lastChimeMinute=totalMin; beep();
    }
  }
}
/* ---------- AUDIO ---------- */
function beep(){
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const osc=ctx.createOscillator(), g=ctx.createGain();
  osc.type='sine'; osc.frequency.value=800; g.gain.value=0.08;
  osc.connect(g).connect(ctx.destination);
  osc.start(); osc.stop(ctx.currentTime+0.06);
}

/* ---------- LOOP ---------- */
let interval=null;
function start(){ if(interval)return; draw(); interval=setInterval(draw,1000); }
start();

/* ---------- SETTINGS HOOKS ---------- */
function applySmooth(){
  const on=smoothCk.checked;
  const t=on?'stroke-dashoffset .3s ease, stroke .3s ease':'none';
  outer.style.transition=t; inner.style.transition=t; secEl.style.transition=t;
  localStorage.setItem(STORE('smooth'),on);
}
smoothCk.onchange=()=>applySmooth();
smoothCk.checked=localStorage.getItem(STORE('smooth'))!=='false';
applySmooth();

cOuter.onchange=e=>{
  document.documentElement.style.setProperty('--outer',e.target.value);
  localStorage.setItem(STORE('cOuter'),e.target.value);
};
cTrack.onchange=e=>{
  document.documentElement.style.setProperty('--track',e.target.value);
  localStorage.setItem(STORE('cTrack'),e.target.value);
};
if(localStorage.getItem(STORE('cOuter'))) cOuter.value=localStorage.getItem(STORE('cOuter'));
if(localStorage.getItem(STORE('cTrack'))) cTrack.value=localStorage.getItem(STORE('cTrack'));
cOuter.onchange({target:cOuter}); cTrack.onchange({target:cTrack});

chimeInp.onchange=e=>{
  chimeEvery=+e.target.value||0;
  localStorage.setItem(STORE('chime'),chimeEvery);
};
chimeInp.value=chimeEvery;

/* ---------- COLLAPSE/EXPAND ---------- */
toggleBtn.onclick=()=>settings.classList.toggle('show');

/* ---------- DEBUG TIME SHIFT ---------- */
document.getElementById('sub10').onclick=()=>{offsetMinutes-=10;saveOff();};
document.getElementById('add10').onclick=()=>{offsetMinutes+=10;saveOff();};
document.getElementById('resetOff').onclick=()=>{offsetMinutes=0;saveOff();};
function saveOff(){
  localStorage.setItem(STORE('offset'),offsetMinutes);
  draw();
}
</script>
</body>
</html>
